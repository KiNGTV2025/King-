name: Update Sozcu TV Playlist

on:
  schedule:
    - cron: '*/15 * * * *'  # 15 dakikada bir çalıştır
  workflow_dispatch:

jobs:
  update-playlist:
    runs-on: ubuntu-latest

    env:
      YOUTUBE_COOKIES: ${{ secrets.YOUTUBE_COOKIES }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Install dependencies
        run: pip install yt-dlp

      - name: Run playlist script
        run: |
          python3 - << 'EOF'
          import subprocess
          import datetime
          import os

          YOUTUBE_URL = "https://www.youtube.com/live/ztmY_cCtUl0"

          output_dir = os.path.join(os.getcwd(), "playlist")
          os.makedirs(output_dir, exist_ok=True)
          OUTPUT_FILE = os.path.join(output_dir, "Sozcu_Tv.m3u8")

          COOKIES_FILE = os.environ.get("YOUTUBE_COOKIES")

          def get_stream(itag):
              try:
                  cmd = [
                      "yt-dlp",
                      "-g",
                      "-f", str(itag),
                      "--add-header", "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64)",
                      "--add-header", "Referer: https://www.youtube.com",
                  ]
                  if COOKIES_FILE:
                      cmd += ["--cookies", COOKIES_FILE]
                  cmd.append(YOUTUBE_URL)

                  result = subprocess.run(cmd, capture_output=True, text=True, check=True)
                  return result.stdout.strip()
              except subprocess.CalledProcessError as e:
                  print(f"Error fetching itag {itag}: {e}")
                  return None

          itag_map = {
              91: "256x144",
              92: "426x240",
              93: "640x360",
              94: "854x480",
              95: "1280x720",
              96: "1920x1080"
          }

          lines = ["#EXTM3U", "#EXT-X-INDEPENDENT-SEGMENTS"]

          for itag, res in itag_map.items():
              url = get_stream(itag)
              if url:
                  lines.append(f'#EXT-X-STREAM-INF:BANDWIDTH=1000000,CODECS="mp4a.40.2,avc1.4D401F",RESOLUTION={res},FRAME-RATE=30,VIDEO-RANGE=SDR,CLOSED-CAPTIONS=NONE')
                  lines.append(url)

          m3u8 = "\n".join(lines) + f"\n# Generated: {datetime.datetime.utcnow().isoformat()} UTC\n"

          with open(OUTPUT_FILE, "w") as f:
              f.write(m3u8)

          print("✅ Sözcü TV playlist güncellendi:", OUTPUT_FILE)
          EOF
