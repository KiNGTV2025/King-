name: ÜMİT TV Güncelleme Raporu

on:
  schedule:
    - cron: "0 3,9,15,21 * * *" # Türkiye saati için (UTC+3) 06:00, 12:00, 18:00, 00:00
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest
    env:
      BOT_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
      CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      M3U_URL: ${{ secrets.M3U_URL }}

    steps:
      - name: Saat ayarını yap
        run: |
          sudo timedatectl set-timezone Europe/Istanbul
          echo "Zaman dilimi Türkiye saati (UTC+3) olarak ayarlandı: $(date)"

      - name: Önceki bildirimleri temizle
        run: |
          RESPONSE=$(curl -s "https://api.telegram.org/bot${BOT_TOKEN}/getUpdates?chat_id=${CHAT_ID}")
          echo $RESPONSE | jq -r '.result[] | select(.message.text | contains("ÜMİT TV KANAL GÜNCELLEME RAPORU")) | .message.message_id' | \
          while read -r msg_id; do
            curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/deleteMessage" \
              -d "chat_id=${CHAT_ID}&message_id=$msg_id"
          done
        continue-on-error: true

      - name: Verileri hazırla
        uses: actions/checkout@v4

      - name: Önceki veriyi kontrol et
        id: check-artifact
        run: |
          if gh run download --name category_counts 2>/dev/null; then
            echo "::set-output name=exists::true"
          else
            echo "::set-output name=exists::false"
            touch old_counts.txt
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: M3U listesini indir ve kontrol et
        run: |
          curl -s -L "$M3U_URL" -o playlist.m3u
          if [ ! -s playlist.m3u ]; then
            echo "Hata: M3U dosyası boş veya indirilemedi!"
            exit 1
          fi
          echo "M3U dosyası başarıyla indirildi, satır sayısı: $(wc -l < playlist.m3u)"

      - name: Kategorileri analiz et
        run: |
          echo "Kategoriler çıkarılıyor..."
          grep -oP 'group-title="\K[^"]+' playlist.m3u > categories_raw.txt
          
          # Kategorileri temizle ve say
          sed -e 's/[Bb][Ee][Ii][Nn]/Morpaket/g' \
              -e 's/^[[:space:]]*//' \
              -e 's/[[:space:]]*$//' \
              -e '/^$/d' categories_raw.txt \
          | sort | uniq -c | sort -nr \
          | awk '{print $1 "|" $2}' > new_counts.txt
          
          echo "İlk 5 kategori örneği:"
          head -n 5 new_counts.txt

          # Eğer eski veri yoksa boş dosya oluştur
          if [ ! -f old_counts.txt ]; then
            touch old_counts.txt
          fi

      - name: Rapor oluştur
        run: |
          # Türkiye saatine göre tarih
          REPORT_DATE=$(TZ="Europe/Istanbul" date '+%d.%m.%Y %H:%M:%S')
          
          # Toplam kanal hesaplamaları
          NEW_TOTAL=$(awk -F'|' '{sum+=$1} END{print sum}' new_counts.txt)
          OLD_TOTAL=$(awk -F'|' '{sum+=$1} END{print sum}' old_counts.txt 2>/dev/null || echo 0)
          DELTA=$((NEW_TOTAL - OLD_TOTAL))
          
          # Rapor başlığı
          MESSAGE="<b>📊 ÜMİT TV KANAL GÜNCELLEME RAPORU</b>\n\n"
          MESSAGE+="<b>🕒 Son Güncelleme:</b> <code>$REPORT_DATE</code>\n"
          MESSAGE+="<b>📈 Toplam Kanal:</b> <b>$NEW_TOTAL</b>"
          
          if [ $DELTA -gt 0 ]; then
            MESSAGE+=" (🟢 +$DELTA)"
          elif [ $DELTA -lt 0 ]; then
            MESSAGE+=" (🔴 $DELTA)"
          else
            MESSAGE+=" (⚪ Değişiklik yok)"
          fi
          MESSAGE+="\n\n"

          # Kategori sıralaması
          MESSAGE+="<b>🏆 EN ÇOK KANAL İÇEREN 10 KATEGORİ</b>\n"
          if [ -s new_counts.txt ]; then
            head -10 new_counts.txt | awk -F'|' '{printf "▫️ %-25s %-4s\n", $2, $1}' | while read -r line; do
              MESSAGE+="$line\n"
            done
          else
            MESSAGE+="⚠️ Kategori bilgisi bulunamadı\n"
          fi
          MESSAGE+="\n"

          # Değişiklikler
          MESSAGE+="<b>🔄 SON DEĞİŞİKLİKLER</b>\n"
          
          # Yeni kategoriler
          NEW_CATS=$(comm -23 <(cut -d'|' -f2 new_counts.txt | sort) <(cut -d'|' -f2 old_counts.txt 2>/dev/null | sort))
          if [ -n "$NEW_CATS" ]; then
            MESSAGE+="\n<u>➕ Yeni Eklenenler:</u>\n"
            echo "$NEW_CATS" | while read -r cat; do
              count=$(grep -F "|$cat|" new_counts.txt | cut -d'|' -f1)
              MESSAGE+="🆕 <b>$cat</b> ($count kanal)\n"
            done
          else
            MESSAGE+="\n<u>➕ Yeni eklenen kategori yok</u>\n"
          fi

          # Kaldırılan kategoriler
          DEL_CATS=$(comm -13 <(cut -d'|' -f2 new_counts.txt | sort) <(cut -d'|' -f2 old_counts.txt 2>/dev/null | sort))
          if [ -n "$DEL_CATS" ]; then
            MESSAGE+="\n<u>➖ Kaldırılanlar:</u>\n"
            echo "$DEL_CATS" | while read -r cat; do
              old_count=$(grep -F "|$cat|" old_counts.txt | cut -d'|' -f1)
              MESSAGE+="🗑️ <b>$cat</b> (önceki: $old_count kanal)\n"
            done
          else
            MESSAGE+="\n<u>➖ Kaldırılan kategori yok</u>\n"
          fi

          # Değişen kategoriler
          CHANGED=0
          while IFS='|' read -r new_count cat; do
            old_count=$(grep -F "|$cat|" old_counts.txt 2>/dev/null | cut -d'|' -f1 || echo 0)
            if [ "$old_count" -ne 0 ] && [ "$old_count" -ne "$new_count" ]; then
              if [ $CHANGED -eq 0 ]; then
                MESSAGE+="\n<u>🔄 Güncellenenler:</u>\n"
                CHANGED=1
              fi
              delta=$((new_count - old_count))
              if [ $delta -gt 0 ]; then
                MESSAGE+="📈 <b>$cat</b>: $new_count kanal (<code>+$delta</code>)\n"
              else
                MESSAGE+="📉 <b>$cat</b>: $new_count kanal (<code>$delta</code>)\n"
              fi
            fi
          done < new_counts.txt

          [ $CHANGED -eq 0 ] && MESSAGE+="\n<u>🔄 Güncellenen kategori yok</u>\n"

          # Simge açıklamaları
          MESSAGE+="\n<b>📌 SİMGE AÇIKLAMALARI</b>\n"
          MESSAGE+="🟢 - Toplam kanal artışı\n"
          MESSAGE+="🔴 - Toplam kanal azalışı\n"
          MESSAGE+="⚪ - Değişiklik yok\n"
          MESSAGE+="🆕 - Yeni eklenen kategori\n"
          MESSAGE+="🗑️ - Kaldırılan kategori\n"
          MESSAGE+="📈 - Kanal sayısı artan kategori\n"
          MESSAGE+="📉 - Kanal sayısı azalan kategori\n\n"
          MESSAGE+="<i>🔔 Otomatik güncelleme - ÜMİT TV</i>"

          echo -e "$MESSAGE" > message.txt
          echo "Rapor oluşturuldu:"
          cat message.txt

      - name: Raporu gönder
        run: |
          curl -s -X POST \
            "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -d "chat_id=${CHAT_ID}" \
            -d "text=$(cat message.txt)" \
            -d "parse_mode=HTML" \
            -o curl_output.txt
          echo "Telegram yanıtı:"
          cat curl_output.txt

      - name: Yeni veriyi kaydet
        uses: actions/upload-artifact@v4
        with:
          name: category_counts
          path: new_counts.txt
          retention-days: 7
