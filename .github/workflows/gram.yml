name: ÃœMÄ°T TV GÃ¼ncelleme Raporu

on:
  schedule:
    - cron: "0 3,9,15,21 * * *" # TÃ¼rkiye saati 06:00, 12:00, 18:00, 00:00
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest
    env:
      BOT_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
      CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      M3U_URL: ${{ secrets.M3U_URL }}

    steps:
      - name: Repo'yu al
        uses: actions/checkout@v4

      - name: Ã–nceki veriyi indir
        run: |
          gh run download --name category_counts || echo "Ã–nceki veri bulunamadÄ±."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Eski veri kontrolÃ¼
        run: |
          if [ ! -f old_counts.txt ]; then
            touch old_counts.txt
          fi

      - name: M3U dosyasÄ±nÄ± indir
        run: curl -s -L "$M3U_URL" -o playlist.m3u

      - name: Kategori analizi yap ve rapor hazÄ±rla
        run: |
          grep -oP 'group-title="\K[^"]+' playlist.m3u \
          | tr -d '\r' \
          | sed 's/[[:space:]]\+/ /g' \
          | sed -E 's/([Bb][Ee][Ii][Nn])/Morpaket/g' \
          | sort \
          | uniq -c \
          | awk '{$1=$1; count=$1; $1=""; name=substr($0,2); print count "|" name}' > new_counts.txt

          if [ -s old_counts.txt ]; then
            sed -i -E 's/([Bb][Ee][Ii][Nn])/Morpaket/g' old_counts.txt
          fi

          NEW_TOTAL=$(awk -F"|" '{sum += $1} END {print sum}' new_counts.txt)
          OLD_TOTAL=$(awk -F"|" '{sum += $1} END {print sum}' old_counts.txt 2>/dev/null || echo 0)
          CHANGE=$((NEW_TOTAL - OLD_TOTAL))
          PERCENT="0"
          if [ "$OLD_TOTAL" -gt 0 ]; then
            PERCENT=$(awk "BEGIN {printf \"%.2f\", ($CHANGE/$OLD_TOTAL)*100}")
          fi

          MESSAGE="ğŸ“Š <b>ÃœMÄ°T TV - GÃ¼nlÃ¼k Kanal Raporu</b>\n"
          MESSAGE+="â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
          MESSAGE+="<b>ğŸ“… Tarih:</b> <code>$(date '+%d.%m.%Y %H:%M:%S')</code>\n"
          MESSAGE+="<b>ğŸ“º Toplam Kanal:</b> <b>${NEW_TOTAL}</b>"

          if [ "$CHANGE" -gt 0 ]; then
            MESSAGE+=" (<code>+${CHANGE}</code> | %${PERCENT} â†‘)\n"
          elif [ "$CHANGE" -lt 0 ]; then
            MESSAGE+=" (<code>${CHANGE}</code> | %${PERCENT} â†“)\n"
          else
            MESSAGE+=" (DeÄŸiÅŸiklik yok)\n"
          fi

          MESSAGE+="â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"

          TEMP_NEW=$(mktemp)
          TEMP_REMOVED=$(mktemp)
          TEMP_CHANGED=$(mktemp)
          TEMP_UNCHANGED=$(mktemp)

          comm -23 <(cut -d"|" -f2 new_counts.txt | sort) <(cut -d"|" -f2 old_counts.txt | sort) > new_categories.txt
          while read -r CATEGORY; do
            COUNT=$(grep -F "|${CATEGORY}" new_counts.txt | cut -d"|" -f1)
            echo "ğŸ†• <b>${CATEGORY}</b>: ${COUNT} kanal" >> "$TEMP_NEW"
          done < new_categories.txt

          comm -13 <(cut -d"|" -f2 new_counts.txt | sort) <(cut -d"|" -f2 old_counts.txt | sort) > removed_categories.txt
          while read -r CATEGORY; do
            OLD_COUNT=$(grep -F "|${CATEGORY}" old_counts.txt | cut -d"|" -f1)
            echo "âŒ <b>${CATEGORY}</b>: Ã–nce ${OLD_COUNT}, ÅŸimdi 0" >> "$TEMP_REMOVED"
          done < removed_categories.txt

          while IFS="|" read -r COUNT CATEGORY; do
            OLD_COUNT=$(grep -F "|${CATEGORY}" old_counts.txt | cut -d"|" -f1)
            if [ -n "$OLD_COUNT" ] && [ "$COUNT" -ne "$OLD_COUNT" ]; then
              if [ "$COUNT" -gt "$OLD_COUNT" ]; then
                echo "â¬†ï¸ <b>${CATEGORY}</b>: ${COUNT} (+$((COUNT - OLD_COUNT)))" >> "$TEMP_CHANGED"
              else
                echo "â¬‡ï¸ <b>${CATEGORY}</b>: ${COUNT} (-$((OLD_COUNT - COUNT)))" >> "$TEMP_CHANGED"
              fi
            elif [ -n "$OLD_COUNT" ]; then
              echo "âºï¸ <b>${CATEGORY}</b>: ${COUNT} kanal (deÄŸiÅŸmedi)" >> "$TEMP_UNCHANGED"
            fi
          done < new_counts.txt

          if [ -s "$TEMP_NEW" ]; then
            MESSAGE+="\n<b>ğŸŒŸ Yeni Kategoriler</b>\n"
            MESSAGE+=$(cat "$TEMP_NEW")
          fi
          if [ -s "$TEMP_REMOVED" ]; then
            MESSAGE+="\n\n<b>ğŸ—‘ï¸ KaldÄ±rÄ±lan Kategoriler</b>\n"
            MESSAGE+=$(cat "$TEMP_REMOVED")
          fi
          if [ -s "$TEMP_CHANGED" ]; then
            MESSAGE+="\n\n<b>ğŸ”„ DeÄŸiÅŸen Kategoriler</b>\n"
            MESSAGE+=$(cat "$TEMP_CHANGED")
          fi
          if [ -s "$TEMP_UNCHANGED" ]; then
            MESSAGE+="\n\n<b>âš–ï¸ DeÄŸiÅŸmeyen Kategoriler</b>\n"
            MESSAGE+=$(cat "$TEMP_UNCHANGED")
          fi

          MESSAGE+="\n\n<i>Bu rapor otomatik olarak oluÅŸturulmuÅŸtur.</i>"

          echo -e "$MESSAGE" > message.txt

      - name: Telegram'a gÃ¶nder (parÃ§alÄ±)
        run: |
          TEXT=$(cat message.txt)
          MAX=4000  # 96 karakter gÃ¼venlik payÄ±
          LEN=${#TEXT}
          i=0
          while [ $i -lt $LEN ]; do
            PART=$(echo "$TEXT" | cut -c$((i+1))-$((i+MAX)))
            curl -s --data-urlencode "text=$PART" \
              -d "chat_id=${CHAT_ID}" \
              -d "parse_mode=HTML" \
              "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage"
            i=$((i+MAX))
            sleep 1
          done

      - name: Veriyi gÃ¼ncelle
        run: mv new_counts.txt old_counts.txt

      - name: Yeni veriyi kaydet
        uses: actions/upload-artifact@v4
        with:
          name: category_counts
          path: old_counts.txt
