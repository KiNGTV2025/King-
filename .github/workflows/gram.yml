name: √úMƒ∞T TV G√ºncelleme Bildirimi

on:
  schedule:
    - cron: "0 3,9,15,21 * * *"  # T√ºrkiye saatiyle 06:00, 12:00, 18:00, 00:00
  workflow_dispatch: # Manuel tetikleme

jobs:
  notify:
    runs-on: ubuntu-latest
    env:
      BOT_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
      CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      M3U_URL: ${{ secrets.M3U_URL }}

    steps:
      - name: Repo'yu al
        uses: actions/checkout@v4

      - name: √ñnceki veriyi indir (varsa)
        run: |
          echo "Eski artifact kontrol ediliyor..."
          gh run download --name category_counts || echo "Eski artifact bulunamadƒ±."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Eƒüer eski veri yoksa bo≈ü dosya olu≈ütur
        run: |
          if [ ! -f old_counts.txt ]; then
            echo "Eski veri bulunamadƒ±, bo≈ü dosya olu≈üturuluyor."
            touch old_counts.txt
          fi

      - name: M3U dosyasƒ±nƒ± indir
        run: curl -s -L "$M3U_URL" -o playlist.m3u

      - name: Yeni kategori sayƒ±mƒ±nƒ± √ßƒ±kar (bein ‚Üí Morpaket)
        run: |
          grep -oP 'group-title="\K[^"]+' playlist.m3u \
          | sed -E 's/([Bb][Ee][Ii][Nn])/Morpaket/g' \
          | awk '!seen[$0]++ {print $0}' > category_order.txt

          grep -oP 'group-title="\K[^"]+' playlist.m3u \
          | sed -E 's/([Bb][Ee][Ii][Nn])/Morpaket/g' \
          | sort | uniq -c > new_counts.txt

      - name: Mesajƒ± hazƒ±rla
        run: |
          if [ -s old_counts.txt ]; then
            sed -i -E 's/([Bb][Ee][Ii][Nn])/Morpaket/g' old_counts.txt
          fi

          NEW_TOTAL=$(awk '{sum += $1} END {print sum}' new_counts.txt)
          OLD_TOTAL=$(awk '{sum += $1} END {print sum}' old_counts.txt 2>/dev/null || echo 0)
          CHANGE=$((NEW_TOTAL - OLD_TOTAL))
          PERCENT="0"
          if [ "$OLD_TOTAL" -gt 0 ]; then
            PERCENT=$(awk "BEGIN {printf \"%.2f\", ($CHANGE/$OLD_TOTAL)*100}")
          fi

          MESSAGE="üì∫ <b>√úMƒ∞T TV G√úNCELLENDƒ∞</b>\n"
          MESSAGE+="<i>Tarih:</i> <code>$(date '+%Y-%m-%d %H:%M:%S')</code>\n"
          MESSAGE+="<b>Kategoriler:</b>\n"

          TEMP_CHANGE=$(mktemp)
          TEMP_SAME=$(mktemp)

          while read -r CATEGORY; do
            COUNT=$(grep -F "$CATEGORY" new_counts.txt | awk '{print $1}')
            OLD_COUNT=$(grep -F "$CATEGORY" old_counts.txt 2>/dev/null | awk '{print $1}')
            if [ -z "$OLD_COUNT" ] || [ "$OLD_TOTAL" -eq 0 ]; then
              ICON="üü¢"
              echo "${ICON} <b>${CATEGORY}</b>: ${COUNT} kanal" >> "$TEMP_CHANGE"
            elif [ "$COUNT" -gt "$OLD_COUNT" ]; then
              ICON="‚úÖ"
              echo "${ICON} <b>${CATEGORY}</b>: ${COUNT} kanal" >> "$TEMP_CHANGE"
            elif [ "$COUNT" -lt "$OLD_COUNT" ]; then
              ICON="üîª"
              echo "${ICON} <b>${CATEGORY}</b>: ${COUNT} kanal" >> "$TEMP_CHANGE"
            else
              ICON="‚ö™"
              echo "${ICON} <b>${CATEGORY}</b>: ${COUNT} kanal" >> "$TEMP_SAME"
            fi
          done < category_order.txt

          cat "$TEMP_CHANGE" "$TEMP_SAME" > sorted_list.txt

          while read -r LINE; do
            MESSAGE+="${LINE}\n"
          done < sorted_list.txt

          MESSAGE+="\n<b>üìä Toplam:</b> ${NEW_TOTAL} kanal"
          if [ "$CHANGE" -gt 0 ]; then
            MESSAGE+=" (‚úÖ +${CHANGE} | %${PERCENT})"
          elif [ "$CHANGE" -lt 0 ]; then
            MESSAGE+=" (üîª ${CHANGE} | %${PERCENT})"
          fi
          MESSAGE+="\n\n<b>üìù A√ßƒ±klama:</b>\n"
          MESSAGE+="üü¢ Yeni kategori eklendi\n"
          MESSAGE+="‚úÖ Kanal sayƒ±sƒ± arttƒ±\n"
          MESSAGE+="üîª Kanal sayƒ±sƒ± azaldƒ±\n"
          MESSAGE+="‚ö™ Deƒüi≈üiklik yok\n"

          echo -e "$MESSAGE" > message.txt

      - name: Telegram mesajƒ±nƒ± g√∂nder
        run: |
          curl -s --data-urlencode "text=$(cat message.txt)" \
            -d "chat_id=${CHAT_ID}" \
            -d "parse_mode=HTML" \
            "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage"

      - name: Yeni veriyi artifact olarak kaydet
        run: mv new_counts.txt old_counts.txt

      - name: Artifact y√ºkle
        uses: actions/upload-artifact@v4
        with:
          name: category_counts
          path: old_counts.txt
