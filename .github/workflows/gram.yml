name: ÃœMÄ°T TV GÃ¼ncelleme Raporu

on:
  schedule:
    - cron: "0 6,12,18,0 * * *"
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest
    env:
      BOT_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
      CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      M3U_URL: ${{ secrets.M3U_URL }}

    steps:
      - name: Repo'yu al
        uses: actions/checkout@v4

      - name: Ã–nceki bildirimleri temizle
        run: |
          RESPONSE=$(curl -s "https://api.telegram.org/bot${BOT_TOKEN}/getUpdates?chat_id=${CHAT_ID}")
          echo $RESPONSE | jq -r '.result[] | select(.message.text | contains("ÃœMÄ°T TV KANAL GÃœNCELLEME RAPORU")) | .message.message_id' | \
          while read -r msg_id; do
            curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/deleteMessage" \
              -d "chat_id=${CHAT_ID}&message_id=$msg_id"
          done
        continue-on-error: true

      - name: Ã–nceki veriyi indir
        uses: actions/download-artifact@v4
        with:
          name: category_counts
          path: .
        continue-on-error: true

      - name: M3U dosyasÄ±nÄ± indir
        run: curl -s -L "$M3U_URL" -o playlist.m3u

      - name: Kategori analizi yap
        run: |
          # Kategorileri Ã§Ä±kar ve sÄ±rala
          grep -oP 'group-title="\K[^"]+' playlist.m3u \
          | tr -d '\r' \
          | sed 's/[[:space:]]\+/ /g' \
          | sed -E 's/([Bb][Ee][Ii][Nn])/Morpaket/g' \
          | sort \
          | uniq -c \
          | sort -nr \
          | awk '{$1=$1; print $0}' \
          | awk '{count=$1; $1=""; gsub(/^ /,"",$0); print count "|" $0}' > new_counts.txt

          # EÄŸer eski veri yoksa boÅŸ dosya oluÅŸtur
          if [ ! -f old_counts.txt ]; then
            touch old_counts.txt
          fi

      - name: Rapor oluÅŸtur
        run: |
          # Toplam kanal hesaplamalarÄ±
          NEW_TOTAL=$(awk -F"|" '{sum += $1} END {print sum}' new_counts.txt)
          OLD_TOTAL=$(awk -F"|" '{sum += $1} END {print sum}' old_counts.txt 2>/dev/null || echo 0)
          CHANGE=$((NEW_TOTAL - OLD_TOTAL))
          PERCENT="0"
          if [ "$OLD_TOTAL" -gt 0 ]; then
            PERCENT=$(awk "BEGIN {printf \"%.2f\", ($CHANGE/$OLD_TOTAL)*100}")
          fi

          # Rapor baÅŸlÄ±ÄŸÄ±
          MESSAGE="<b>ğŸ“Š ÃœMÄ°T TV KANAL GÃœNCELLEME RAPORU</b>\n\n"
          MESSAGE+="<b>ğŸ•’ Son GÃ¼ncelleme:</b> <code>$(date '+%d.%m.%Y %H:%M:%S')</code>\n"
          MESSAGE+="<b>ğŸ”¢ Toplam Kanal:</b> <b>${NEW_TOTAL}</b>"
          
          if [ "$CHANGE" -gt 0 ]; then
            MESSAGE+=" (<code>â†‘+${CHANGE}</code> | %${PERCENT})\n\n"
          elif [ "$CHANGE" -lt 0 ]; then
            MESSAGE+=" (<code>â†“${CHANGE}</code> | %${PERCENT})\n\n"
          else
            MESSAGE+=" (<code>â†’ DeÄŸiÅŸiklik yok</code>)\n\n"
          fi

          # Kategori sÄ±ralamasÄ± (en Ã§ok kanaldan en aza)
          MESSAGE+="<b>ğŸ† KATEGORÄ° SIRALAMASI</b> (Top 10)\n"
          head -n 10 new_counts.txt | awk -F"|" '{print "ğŸ… " $2 ": <b>" $1 "</b> kanal"}' | while read -r LINE; do
            MESSAGE+="${LINE}\n"
          done
          MESSAGE+="\n"

          # Kategori deÄŸiÅŸiklikleri
          MESSAGE+="<b>ğŸ“‹ KATEGORÄ° DEÄÄ°ÅÄ°KLÄ°KLERÄ°</b>\n"

          # Yeni kategoriler
          NEW_CATS=$(comm -23 <(cut -d"|" -f2 new_counts.txt | sort) <(cut -d"|" -f2 old_counts.txt 2>/dev/null | sort))
          if [ -n "$NEW_CATS" ]; then
            MESSAGE+="\n<b>ğŸŒŸ YENÄ° KATEGORÄ°LER</b>\n"
            echo "$NEW_CATS" | while read -r CATEGORY; do
              COUNT=$(grep -F "|${CATEGORY}" new_counts.txt | cut -d"|" -f1)
              MESSAGE+="ğŸ†• <b>${CATEGORY}</b>: ${COUNT} kanal\n"
            done
          fi

          # KaldÄ±rÄ±lan kategoriler
          REMOVED_CATS=$(comm -13 <(cut -d"|" -f2 new_counts.txt | sort) <(cut -d"|" -f2 old_counts.txt 2>/dev/null | sort))
          if [ -n "$REMOVED_CATS" ]; then
            MESSAGE+="\n<b>âŒ KALDIRILAN KATEGORÄ°LER</b>\n"
            echo "$REMOVED_CATS" | while read -r CATEGORY; do
              OLD_COUNT=$(grep -F "|${CATEGORY}" old_counts.txt | cut -d"|" -f1)
              MESSAGE+="âŒ <b>${CATEGORY}</b>: 0 kanal (Ã¶nceki: ${OLD_COUNT})\n"
            done
          fi

          # DeÄŸiÅŸen kategoriler
          CHANGED_CATS=$(while IFS="|" read -r COUNT CATEGORY; do
            OLD_COUNT=$(grep -F "|${CATEGORY}" old_counts.txt 2>/dev/null | cut -d"|" -f1)
            if [ -n "$OLD_COUNT" ] && [ "$OLD_COUNT" -ne "$COUNT" ]; then
              echo "${CATEGORY}|${COUNT}|${OLD_COUNT}"
            fi
          done < new_counts.txt)

          if [ -n "$CHANGED_CATS" ]; then
            MESSAGE+="\n<b>ğŸ”„ DEÄÄ°ÅEN KATEGORÄ°LER</b>\n"
            echo "$CHANGED_CATS" | while IFS="|" read -r CATEGORY COUNT OLD_COUNT; do
              if [ "$COUNT" -gt "$OLD_COUNT" ]; then
                MESSAGE+="â¬†ï¸ <b>${CATEGORY}</b>: ${COUNT} kanal (<code>â†‘+$((COUNT - OLD_COUNT))</code>)\n"
              else
                MESSAGE+="â¬‡ï¸ <b>${CATEGORY}</b>: ${COUNT} kanal (<code>â†“-$((OLD_COUNT - COUNT))</code>)\n"
              fi
            done
          fi

          # DeÄŸiÅŸmeyen kategoriler (sadece ilk 5 gÃ¶ster)
          UNCHANGED_CATS=$(while IFS="|" read -r COUNT CATEGORY; do
            OLD_COUNT=$(grep -F "|${CATEGORY}" old_counts.txt 2>/dev/null | cut -d"|" -f1)
            if [ -n "$OLD_COUNT" ] && [ "$OLD_COUNT" -eq "$COUNT" ]; then
              echo "${CATEGORY}|${COUNT}"
            fi
          done < new_counts.txt | head -n 5)

          if [ -n "$UNCHANGED_CATS" ]; then
            MESSAGE+="\n<b>âºï¸ DEÄÄ°ÅMEYEN KATEGORÄ°LER</b> (Ä°lk 5)\n"
            echo "$UNCHANGED_CATS" | while IFS="|" read -r CATEGORY COUNT; do
              MESSAGE+="âºï¸ <b>${CATEGORY}</b>: ${COUNT} kanal\n"
            done
          fi

          # AÃ§Ä±klamalar
          MESSAGE+="\n<b>ğŸ“Œ AÃ‡IKLAMALAR</b>\n"
          MESSAGE+="ğŸ†• <b>Yeni Kategori:</b> Listeye yeni eklenen kanal grubu\n"
          MESSAGE+="â¬†ï¸ <b>ArtÄ±ÅŸ:</b> Kanal sayÄ±sÄ±nda artÄ±ÅŸ olan kategori\n"
          MESSAGE+="â¬‡ï¸ <b>AzalÄ±ÅŸ:</b> Kanal sayÄ±sÄ±nda azalÄ±ÅŸ olan kategori\n"
          MESSAGE+="âºï¸ <b>Sabit:</b> DeÄŸiÅŸiklik olmayan kategori\n"
          MESSAGE+="âŒ <b>KaldÄ±rÄ±lan:</b> Listeden Ã§Ä±karÄ±lan kategori\n\n"
          MESSAGE+="<i>â„¹ï¸ Otomatik gÃ¼ncelleme raporu - ÃœMÄ°T TV</i>"

          echo -e "$MESSAGE" > message.txt
          cat message.txt

      - name: Telegram'a gÃ¶nder
        run: |
          curl -s --data-urlencode "text=$(cat message.txt)" \
            -d "chat_id=${CHAT_ID}" \
            -d "parse_mode=HTML" \
            "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage"

      - name: Veriyi gÃ¼ncelle
        run: mv new_counts.txt old_counts.txt

      - name: Yeni veriyi kaydet
        uses: actions/upload-artifact@v4
        with:
          name: category_counts
          path: old_counts.txt
