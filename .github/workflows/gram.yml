name: ÃœMÄ°T TV GÃ¼ncelleme Raporu

on:
  schedule:
    - cron: "0 3,9,15,21 * * *" # TÃ¼rkiye saati iÃ§in (UTC+3) 06:00, 12:00, 18:00, 00:00
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest
    env:
      BOT_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
      CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      M3U_URL: ${{ secrets.M3U_URL }}

    steps:
      - name: Saat ayarÄ±nÄ± yap
        run: |
          sudo timedatectl set-timezone Europe/Istanbul
          echo "Zaman dilimi TÃ¼rkiye saati (UTC+3) olarak ayarlandÄ±: $(date)"

      - name: Ã–nceki bildirimleri temizle
        run: |
          RESPONSE=$(curl -s "https://api.telegram.org/bot${BOT_TOKEN}/getUpdates?chat_id=${CHAT_ID}")
          echo $RESPONSE | jq -r '.result[] | select(.message.text | contains("ÃœMÄ°T TV KANAL GÃœNCELLEME RAPORU")) | .message.message_id' | \
          while read -r msg_id; do
            curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/deleteMessage" \
              -d "chat_id=${CHAT_ID}&message_id=$msg_id"
          done
        continue-on-error: true

      - name: Verileri hazÄ±rla
        uses: actions/checkout@v4

      - name: Eski veriyi baÅŸlat
        run: |
          if [ ! -f old_counts.txt ]; then
            echo "Eski veri dosyasÄ± oluÅŸturuluyor..."
            touch old_counts.txt
          fi
          echo "Mevcut old_counts.txt iÃ§eriÄŸi:"
          cat old_counts.txt || echo "Dosya boÅŸ"

      - name: M3U listesini indir ve kontrol et
        run: |
          echo "M3U listesi indiriliyor: $M3U_URL"
          curl -s -L "$M3U_URL" -o playlist.m3u
          if [ ! -s playlist.m3u ]; then
            echo "::error::M3U dosyasÄ± boÅŸ veya indirilemedi!"
            exit 1
          fi
          echo "M3U dosyasÄ± baÅŸarÄ±yla indirildi, ilk 5 satÄ±r:"
          head -n 5 playlist.m3u

      - name: Kategorileri analiz et
        run: |
          echo "Kategoriler Ã§Ä±karÄ±lÄ±yor..."
          
          # Kategorileri Ã§Ä±kar ve temizle
          grep -oP 'group-title="\K[^"]+' playlist.m3u | \
          sed -e 's/[Bb][Ee][Ii][Nn]/Morpaket/g' \
              -e 's/^[[:space:]]*//' \
              -e 's/[[:space:]]*$//' \
              -e '/^$/d' | \
          sort | uniq -c | sort -nr | \
          awk '{print $1 "|" $2}' > new_counts.txt
          
          echo "Kategori analizi tamamlandÄ±, ilk 10 kayÄ±t:"
          head -n 10 new_counts.txt
          echo "Toplam kategori sayÄ±sÄ±: $(wc -l < new_counts.txt)"

      - name: Rapor oluÅŸtur
        run: |
          # TÃ¼rkiye saatine gÃ¶re tarih
          REPORT_DATE=$(TZ="Europe/Istanbul" date '+%d.%m.%Y %H:%M:%S')
          
          # Toplam kanal hesaplamalarÄ±
          NEW_TOTAL=$(awk -F'|' '{sum+=$1} END{print sum}' new_counts.txt)
          OLD_TOTAL=$(awk -F'|' '{sum+=$1} END{print sum}' old_counts.txt 2>/dev/null || echo 0)
          DELTA=$((NEW_TOTAL - OLD_TOTAL))
          
          # Rapor baÅŸlÄ±ÄŸÄ±
          MESSAGE="<b>ğŸ“Š ÃœMÄ°T TV KANAL GÃœNCELLEME RAPORU</b>\n\n"
          MESSAGE+="<b>ğŸ•’ Son GÃ¼ncelleme:</b> <code>$REPORT_DATE</code>\n"
          MESSAGE+="<b>ğŸ“ˆ Toplam Kanal:</b> <b>$NEW_TOTAL</b>"
          
          if [ $DELTA -gt 0 ]; then
            MESSAGE+=" (ğŸŸ¢ +$DELTA)"
          elif [ $DELTA -lt 0 ]; then
            MESSAGE+=" (ğŸ”´ $DELTA)"
          else
            MESSAGE+=" (âšª DeÄŸiÅŸiklik yok)"
          fi
          MESSAGE+="\n\n"

          # Kategori sÄ±ralamasÄ±
          MESSAGE+="<b>ğŸ† EN Ã‡OK KANAL Ä°Ã‡EREN 10 KATEGORÄ°</b>\n"
          if [ -s new_counts.txt ]; then
            head -10 new_counts.txt | awk -F'|' '{printf "â–«ï¸ %-25s %-4s\n", $2, $1}' | while read -r line; do
              MESSAGE+="$line\n"
            done
          else
            MESSAGE+="â„¹ï¸ HiÃ§ kategori bulunamadÄ±\n"
          fi
          MESSAGE+="\n"

          # DeÄŸiÅŸiklikler
          MESSAGE+="<b>ğŸ”„ SON DEÄÄ°ÅÄ°KLÄ°KLER</b>\n"
          
          # Yeni kategoriler
          NEW_CATS=$(comm -23 <(cut -d'|' -f2 new_counts.txt | sort) <(cut -d'|' -f2 old_counts.txt 2>/dev/null | sort))
          if [ -n "$NEW_CATS" ]; then
            MESSAGE+="\n<u>â• Yeni Eklenenler:</u>\n"
            echo "$NEW_CATS" | while read -r cat; do
              count=$(grep -F "|$cat|" new_counts.txt | cut -d'|' -f1)
              MESSAGE+="ğŸ†• <b>$cat</b> ($count kanal)\n"
            done
          else
            MESSAGE+="\n<u>â• Yeni eklenen kategori yok</u>\n"
          fi

          # KaldÄ±rÄ±lan kategoriler
          DEL_CATS=$(comm -13 <(cut -d'|' -f2 new_counts.txt | sort) <(cut -d'|' -f2 old_counts.txt 2>/dev/null | sort))
          if [ -n "$DEL_CATS" ]; then
            MESSAGE+="\n<u>â– KaldÄ±rÄ±lanlar:</u>\n"
            echo "$DEL_CATS" | while read -r cat; do
              old_count=$(grep -F "|$cat|" old_counts.txt | cut -d'|' -f1)
              MESSAGE+="ğŸ—‘ï¸ <b>$cat</b> (Ã¶nceki: $old_count kanal)\n"
            done
          else
            MESSAGE+="\n<u>â– KaldÄ±rÄ±lan kategori yok</u>\n"
          fi

          # DeÄŸiÅŸen kategoriler
          CHANGED=0
          while IFS='|' read -r new_count cat; do
            old_count=$(grep -F "|$cat|" old_counts.txt 2>/dev/null | cut -d'|' -f1 || echo 0)
            if [ "$old_count" -ne 0 ] && [ "$old_count" -ne "$new_count" ]; then
              if [ $CHANGED -eq 0 ]; then
                MESSAGE+="\n<u>ğŸ”„ GÃ¼ncellenenler:</u>\n"
                CHANGED=1
              fi
              delta=$((new_count - old_count))
              if [ $delta -gt 0 ]; then
                MESSAGE+="ğŸ“ˆ <b>$cat</b>: $new_count kanal (<code>+$delta</code>)\n"
              else
                MESSAGE+="ğŸ“‰ <b>$cat</b>: $new_count kanal (<code>$delta</code>)\n"
              fi
            fi
          done < new_counts.txt

          [ $CHANGED -eq 0 ] && MESSAGE+="\n<u>ğŸ”„ GÃ¼ncellenen kategori yok</u>\n"

          # Simge aÃ§Ä±klamalarÄ±
          MESSAGE+="\n<b>ğŸ“Œ SÄ°MGE AÃ‡IKLAMALARI</b>\n"
          MESSAGE+="ğŸŸ¢ - Toplam kanal artÄ±ÅŸÄ±\n"
          MESSAGE+="ğŸ”´ - Toplam kanal azalÄ±ÅŸÄ±\n"
          MESSAGE+="âšª - DeÄŸiÅŸiklik yok\n"
          MESSAGE+="ğŸ†• - Yeni eklenen kategori\n"
          MESSAGE+="ğŸ—‘ï¸ - KaldÄ±rÄ±lan kategori\n"
          MESSAGE+="ğŸ“ˆ - Kanal sayÄ±sÄ± artan kategori\n"
          MESSAGE+="ğŸ“‰ - Kanal sayÄ±sÄ± azalan kategori\n\n"
          MESSAGE+="<i>ğŸ”” Otomatik gÃ¼ncelleme - ÃœMÄ°T TV</i>"

          echo -e "$MESSAGE" > message.txt
          echo "OluÅŸturulan rapor:"
          cat message.txt

      - name: Raporu gÃ¶nder
        run: |
          echo "Telegram mesajÄ± gÃ¶nderiliyor..."
          curl -s -X POST \
            "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -d "chat_id=${CHAT_ID}" \
            -d "text=$(cat message.txt)" \
            -d "parse_mode=HTML" \
            -o curl_output.txt
          echo "Telegram API yanÄ±tÄ±:"
          cat curl_output.txt

      - name: Yeni veriyi kaydet
        uses: actions/upload-artifact@v4
        with:
          name: category_counts
          path: new_counts.txt
          retention-days: 7

      - name: Bir sonraki Ã§alÄ±ÅŸma iÃ§in veriyi hazÄ±rla
        run: |
          cp new_counts.txt old_counts.txt
          echo "Yeni veri bir sonraki Ã§alÄ±ÅŸma iÃ§in hazÄ±rlandÄ±"
          echo "GÃ¼ncellenen old_counts.txt iÃ§eriÄŸi:"
          cat old_counts.txt
