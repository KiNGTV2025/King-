name: ÃœMÄ°T TV GÃ¼ncelleme (Manuel + Debug + Hata Bildirimi)

on:
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest
    env:
      BOT_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
      CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      M3U_URL: ${{ secrets.M3U_URL }}

    steps:
      - name: ğŸ”¹ BaÅŸlat
        run: echo "Workflow baÅŸlatÄ±ldÄ± â€” $(date)"

      - name: ğŸŸ¦ Ã–nceki veriyi indir
        uses: actions/download-artifact@v4
        with:
          name: category_counts
        continue-on-error: true

      - name: ğŸ“„ Eski veri kontrolÃ¼
        run: |
          if [ ! -f old_counts.txt ]; then
            echo "Eski veri yok, boÅŸ dosya oluÅŸturuluyor"
            touch old_counts.txt
          fi

      - name: ğŸŒ M3U indir
        run: |
          echo "M3U indiriliyor: $M3U_URL"
          if ! curl -s -L "$M3U_URL" -o playlist.m3u; then
            echo "M3U indirme hatasÄ±"
            curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
              -d chat_id="${CHAT_ID}" \
              -d parse_mode="HTML" \
              -d text="âŒ <b>ÃœMÄ°T TV GÃ¼ncelleme</b>%0A<i>M3U indirme baÅŸarÄ±sÄ±z oldu!</i>"
            exit 1
          fi
          echo "Dosya boyutu: $(wc -c < playlist.m3u) byte"

      - name: ğŸ“Š Kategori sayÄ±mÄ± (bein â†’ Morpaket)
        run: |
          if ! grep -oP 'group-title="\K[^"]+' playlist.m3u \
          | sed -E 's/([Bb][Ee][Ii][Nn])/Morpaket/g' \
          | awk '!seen[$0]++ {print $0}' > category_order.txt; then
            echo "Kategori ayÄ±klama hatasÄ±"
            curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
              -d chat_id="${CHAT_ID}" \
              -d parse_mode="HTML" \
              -d text="âŒ <b>ÃœMÄ°T TV GÃ¼ncelleme</b>%0A<i>Kategori listesi oluÅŸturulamadÄ±!</i>"
            exit 1
          fi

          grep -oP 'group-title="\K[^"]+' playlist.m3u \
          | sed -E 's/([Bb][Ee][Ii][Nn])/Morpaket/g' \
          | sort | uniq -c > new_counts.txt

          echo "Yeni kategoriler:"
          cat new_counts.txt

      - name: ğŸ“ Mesaj oluÅŸtur ve gÃ¶nder
        run: |
          set -e
          trap 'curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -d chat_id="${CHAT_ID}" \
            -d parse_mode="HTML" \
            -d text="âŒ <b>ÃœMÄ°T TV GÃ¼ncelleme</b>%0A<i>Mesaj oluÅŸturma sÄ±rasÄ±nda hata oluÅŸtu!</i>"' ERR

          if [ -s old_counts.txt ]; then
            sed -i -E 's/([Bb][Ee][Ii][Nn])/Morpaket/g' old_counts.txt
          fi

          NEW_TOTAL=$(awk '{sum += $1} END {print sum}' new_counts.txt)
          OLD_TOTAL=$(awk '{sum += $1} END {print sum}' old_counts.txt 2>/dev/null || echo 0)
          CHANGE=$((NEW_TOTAL - OLD_TOTAL))
          PERCENT="0"
          if [ "$OLD_TOTAL" -gt 0 ]; then
            PERCENT=$(awk "BEGIN {printf \"%.2f\", ($CHANGE/$OLD_TOTAL)*100}")
          fi

          MESSAGE="<b>ğŸ“º ÃœMÄ°T TV GÃœNCELLENDÄ°</b>%0A"
          MESSAGE+="<i>Tarih:</i> <code>$(date '+%Y-%m-%d %H:%M:%S')</code>%0A"

          TEMP_CHANGE=$(mktemp)
          TEMP_SAME=$(mktemp)

          while read -r CATEGORY; do
            COUNT=$(grep -F "$CATEGORY" new_counts.txt | awk '{print $1}')
            OLD_COUNT=$(grep -F "$CATEGORY" old_counts.txt 2>/dev/null | awk '{print $1}')
            if [ -z "$OLD_COUNT" ] || [ "$OLD_TOTAL" -eq 0 ]; then
              ICON="ğŸŸ¢"
              echo "${ICON} <b>${CATEGORY}</b>: ${COUNT} kanal" >> "$TEMP_CHANGE"
            elif [ "$COUNT" -gt "$OLD_COUNT" ]; then
              ICON="âœ…"
              echo "${ICON} <b>${CATEGORY}</b>: ${COUNT} kanal" >> "$TEMP_CHANGE"
            elif [ "$COUNT" -lt "$OLD_COUNT" ]; then
              ICON="ğŸ”»"
              echo "${ICON} <b>${CATEGORY}</b>: ${COUNT} kanal" >> "$TEMP_CHANGE"
            else
              ICON="âšª"
              echo "${ICON} <b>${CATEGORY}</b>: ${COUNT} kanal" >> "$TEMP_SAME"
            fi
          done < category_order.txt

          cat "$TEMP_CHANGE" "$TEMP_SAME" > sorted_list.txt
          while read -r LINE; do
            MESSAGE+="${LINE}%0A"
          done < sorted_list.txt

          MESSAGE+="%0A<b>ğŸ“Š Toplam:</b> ${NEW_TOTAL} kanal"
          if [ "$CHANGE" -gt 0 ]; then
            MESSAGE+=" (âœ… +${CHANGE} | %${PERCENT})"
          elif [ "$CHANGE" -lt 0 ]; then
            MESSAGE+=" (ğŸ”» ${CHANGE} | %${PERCENT})"
          fi

          MESSAGE+="%0A%0A<b>ğŸ“ AÃ§Ä±klama:</b>%0AğŸŸ¢ Yeni kategori%0Aâœ… Kanal arttÄ±%0AğŸ”» AzaldÄ±%0Aâšª AynÄ±%0A"

          echo "Telegram'a mesaj gÃ¶nderiliyor..."
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -d chat_id="${CHAT_ID}" \
            -d parse_mode="HTML" \
            -d text="$MESSAGE"

      - name: ğŸ’¾ Yeni veriyi kaydet
        run: mv new_counts.txt old_counts.txt

      - name: ğŸ“¤ Artifact yÃ¼kle
        uses: actions/upload-artifact@v4
        with:
          name: category_counts
          path: old_counts.txt
