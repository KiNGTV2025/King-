name: ÃœMÄ°T TV GÃ¼ncelleme Raporu

on:
  schedule:
    - cron: "0 3,9,15,21 * * *" # 6 saatte bir (UTC'ye gÃ¶re ayarlandÄ±, TÃ¼rkiye saati UTC+3)
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest
    env:
      BOT_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
      CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      M3U_URL: ${{ secrets.M3U_URL }}

    steps:
      - name: Repo'yu al
        uses: actions/checkout@v4

      - name: Ã–nceki veriyi indir
        run: |
          gh run download --name category_counts || echo "Ã–nceki veri bulunamadÄ±, yeni bir rapor oluÅŸturulacak."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Eski veri kontrolÃ¼
        run: |
          if [ ! -f old_counts.txt ]; then
            touch old_counts.txt
            echo "Ã–nceki veri dosyasÄ± oluÅŸturuldu."
          fi

      - name: M3U dosyasÄ±nÄ± indir
        run: curl -s -L "$M3U_URL" -o playlist.m3u

      - name: Kategori analizi yap
        run: |
          # Kategorileri temizle ve standardize et (orijinal sÄ±rayÄ± koru)
          awk -F'group-title="' '{print $2}' playlist.m3u | awk -F'"' '{print $1}' \
          | tr -d '\r' \
          | sed 's/[[:space:]]\+/ /g' \
          | sed -E 's/([Bb][Ee][Ii][Nn])/Morpaket/g' \
          | awk 'NF' > all_categories.txt
          
          # Kategori sÄ±klÄ±klarÄ±nÄ± hesapla (orijinal sÄ±raya gÃ¶re)
          awk '{
            count[$0]++
            if (!($0 in seen)) {
              seen[$0]
              order[++n] = $0
            }
          } END {
            for (i=1; i<=n; i++) {
              print count[order[i]] "|" order[i]
            }
          }' all_categories.txt > new_counts.txt

      - name: Rapor oluÅŸtur
        run: |
          # Eski veriyi standardize et
          if [ -s old_counts.txt ]; then
            sed -i -E 's/([Bb][Ee][Ii][Nn])/Morpaket/g' old_counts.txt
          fi

          # TÃ¼rkiye saati (UTC+3) iÃ§in zaman ayarÄ±
          TURKEY_TIME=$(TZ="Europe/Istanbul" date '+%d.%m.%Y %H:%M:%S')

          # Toplam kanal hesaplamalarÄ±
          NEW_TOTAL=$(awk -F"|" '{sum += $1} END {print sum}' new_counts.txt)
          OLD_TOTAL=$(awk -F"|" '{sum += $1} END {print sum}' old_counts.txt 2>/dev/null || echo 0)
          CHANGE=$((NEW_TOTAL - OLD_TOTAL))
          PERCENT="0"
          if [ "$OLD_TOTAL" -gt 0 ]; then
            PERCENT=$(awk "BEGIN {printf \"%.2f\", ($CHANGE/$OLD_TOTAL)*100}")
          fi

          # Rapor baÅŸlÄ±ÄŸÄ± (daha profesyonel tasarÄ±m)
          MESSAGE="<b>ğŸ“ˆ ÃœMÄ°T TV KANAL ANALÄ°Z RAPORU</b>\n"
          MESSAGE+="<code>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”</code>\n"
          MESSAGE+="<b>ğŸ•’ GÃ¼ncelleme ZamanÄ±:</b> <code>${TURKEY_TIME}</code>\n"
          MESSAGE+="<b>ğŸ“Š Toplam Kanal:</b> <b>${NEW_TOTAL}</b>"
          
          # DeÄŸiÅŸim bilgisi
          if [ "$CHANGE" -gt 0 ]; then
            MESSAGE+=" (<code>â†‘ +${CHANGE}</code> | %${PERCENT})\n"
          elif [ "$CHANGE" -lt 0 ]; then
            MESSAGE+=" (<code>â†“ ${CHANGE}</code> | %${PERCENT})\n"
          else
            MESSAGE+=" (<code>â†’ 0</code>)\n"
          fi
          MESSAGE+="<code>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”</code>\n\n"

          # Kategori deÄŸiÅŸiklikleri
          MESSAGE+="<b>ğŸ“Œ KATEGORÄ° DETAYLARI</b>\n"

          TEMP_CHANGED=$(mktemp)
          TEMP_NEW=$(mktemp)
          TEMP_REMOVED=$(mktemp)
          TEMP_UNCHANGED=$(mktemp)

          # Yeni kategoriler
          comm -23 <(cut -d"|" -f2 new_counts.txt | sort) <(cut -d"|" -f2 old_counts.txt 2>/dev/null | sort) > new_categories.txt
          if [ -s new_categories.txt ]; then
            MESSAGE+="\n<b>âœ¨ YENÄ° EKLENENLER</b>\n"
            while read -r CATEGORY; do
              COUNT=$(grep -F "|${CATEGORY}" new_counts.txt | cut -d"|" -f1)
              MESSAGE+="â”£ <code>+${COUNT}</code> <b>${CATEGORY}</b>\n"
            done < new_categories.txt
          fi

          # KaldÄ±rÄ±lan kategoriler
          comm -13 <(cut -d"|" -f2 new_counts.txt | sort) <(cut -d"|" -f2 old_counts.txt 2>/dev/null | sort) > removed_categories.txt
          if [ -s removed_categories.txt ]; then
            MESSAGE+="\n<b>ğŸ—‘ï¸ KALDIRILANLAR</b>\n"
            while read -r CATEGORY; do
              OLD_COUNT=$(grep -F "|${CATEGORY}" old_counts.txt | cut -d"|" -f1)
              MESSAGE+="â”£ <code>-${OLD_COUNT}</code> <b>${CATEGORY}</b>\n"
            done < removed_categories.txt
          fi

          # DeÄŸiÅŸen kategoriler
          CHANGED_CATEGORIES=0
          while IFS="|" read -r COUNT CATEGORY; do
            OLD_COUNT=$(grep -F "|${CATEGORY}" old_counts.txt 2>/dev/null | cut -d"|" -f1)
            if [ -n "$OLD_COUNT" ] && [ "$OLD_COUNT" -ne "$COUNT" ]; then
              if [ $CHANGED_CATEGORIES -eq 0 ]; then
                MESSAGE+="\n<b>ğŸ”„ DEÄÄ°ÅÄ°KLÄ°KLER</b>\n"
              fi
              DIFF=$((COUNT - OLD_COUNT))
              if [ "$DIFF" -gt 0 ]; then
                MESSAGE+="â”£ <code>â†‘+${DIFF}</code> <b>${CATEGORY}</b> (<code>${OLD_COUNT} â†’ ${COUNT}</code>)\n"
              else
                MESSAGE+="â”£ <code>â†“${DIFF}</code> <b>${CATEGORY}</b> (<code>${OLD_COUNT} â†’ ${COUNT}</code>)\n"
              fi
              CHANGED_CATEGORIES=$((CHANGED_CATEGORIES+1))
            fi
          done < new_counts.txt

          # Sabit kategoriler (ilk 10)
          UNCHANGED_COUNT=0
          while IFS="|" read -r COUNT CATEGORY; do
            OLD_COUNT=$(grep -F "|${CATEGORY}" old_counts.txt 2>/dev/null | cut -d"|" -f1)
            if [ -n "$OLD_COUNT" ] && [ "$OLD_COUNT" -eq "$COUNT" ]; then
              UNCHANGED_COUNT=$((UNCHANGED_COUNT+1))
            fi
          done < new_counts.txt

          if [ $UNCHANGED_COUNT -gt 0 ]; then
            MESSAGE+="\n<b>âºï¸ SABÄ°T KATEGORÄ°LER</b>\n"
            MESSAGE+="â”£ Toplam <b>${UNCHANGED_COUNT}</b> kategoride deÄŸiÅŸiklik yok\n"
          fi

          # Ä°statistik Ã¶zeti
          MESSAGE+="\n<code>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”</code>\n"
          MESSAGE+="<b>ğŸ“Š Ã–ZET</b>\n"
          MESSAGE+="â”£ <b>Toplam Kanal:</b> <code>${NEW_TOTAL}</code>\n"
          MESSAGE+="â”£ <b>Yeni Kategoriler:</b> <code>$(wc -l < new_categories.txt)</code>\n"
          MESSAGE+="â”£ <b>KaldÄ±rÄ±lanlar:</b> <code>$(wc -l < removed_categories.txt)</code>\n"
          MESSAGE+="â”£ <b>DeÄŸiÅŸenler:</b> <code>${CHANGED_CATEGORIES}</code>\n"
          MESSAGE+="â”— <b>Sabit Kalanlar:</b> <code>${UNCHANGED_COUNT}</code>\n\n"
          MESSAGE+="<i>ğŸ” DetaylÄ± analiz iÃ§in sistem yÃ¶neticinizle iletiÅŸime geÃ§in.</i>\n"
          MESSAGE+="<i>ğŸ”„ Otomatik gÃ¼ncelleme â€¢ ÃœMÄ°T TV</i>"

          echo -e "$MESSAGE" > message.txt

      - name: Telegram'a gÃ¶nder
        run: |
          curl -s -X POST \
            -H "Content-Type: application/json" \
            -d '{
              "chat_id": "'"${CHAT_ID}"'",
              "text": "'"$(cat message.txt | sed 's/"/\\"/g')"'",
              "parse_mode": "HTML",
              "disable_web_page_preview": true
            }' \
            "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage"

      - name: Veriyi gÃ¼ncelle
        run: mv new_counts.txt old_counts.txt

      - name: Yeni veriyi kaydet
        uses: actions/upload-artifact@v4
        with:
          name: category_counts
          path: old_counts.txt
